---
import Button from '../ui/Button.astro';
import Input from '../ui/Input.astro';
import Select from '../ui/Select.astro';
import Textarea from '../ui/Textarea.astro';
import Icon from '../ui/Icon.astro';
import { services } from '../../data/services.js';
import { url } from '../../utils/url.js';

export interface Props {
  variant?: 'full' | 'compact';
}

const { variant = 'full' } = Astro.props;

const serviceOptions = services.map(s => ({
  value: s.slug,
  label: s.shortTitle
}));
---

<form 
  action="https://formspree.io/f/YOUR_FORM_ID" 
  method="POST"
  class="space-y-6"
  id="contact-form"
>
  <!-- Honeypot anti-spam -->
  <input type="text" name="_gotcha" style="display:none" />
  
  {variant === 'full' && (
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
      <Input 
        name="prenom" 
        label="Prénom" 
        placeholder="Votre prénom" 
        required 
        autocomplete="given-name"
      />
      <Input 
        name="nom" 
        label="Nom" 
        placeholder="Votre nom" 
        required 
        autocomplete="family-name"
      />
    </div>
  )}
  
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
    <Input 
      type="email" 
      name="email" 
      label="Email" 
      placeholder="votre@email.com" 
      required 
      autocomplete="email"
    />
    <Input 
      type="tel" 
      name="telephone" 
      label="Téléphone" 
      placeholder="06 XX XX XX XX" 
      required 
      autocomplete="tel"
    />
  </div>
  
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
    <Select 
      name="service" 
      label="Type de service" 
      options={serviceOptions}
      placeholder="Sélectionnez un service"
      required
    />
    <Input 
      name="code_postal" 
      label="Code postal" 
      placeholder="75001" 
      required
    />
  </div>
  
  <Textarea 
    name="message" 
    label="Description du besoin" 
    placeholder="Décrivez votre problème en quelques mots..."
    rows={4}
    required
  />
  
  <!-- Consent -->
  <div class="flex items-start gap-3">
    <input 
      type="checkbox" 
      id="consent" 
      name="consent" 
      required
      class="mt-1 w-5 h-5 text-w4s-accent border-w4s-concrete rounded focus:ring-w4s-accent"
    />
    <label for="consent" class="text-small text-w4s-navy/70">
      J'accepte d'être recontacté par W4S pour ma demande. 
      <a href={url('/politique-confidentialite')} class="text-w4s-accent hover:underline">
        Politique de confidentialité
      </a>
    </label>
  </div>
  
  <!-- Submit -->
  <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
    <Button type="submit" variant="primary" size="lg">
      Envoyer ma demande
      <Icon name="arrow-right" size={20} />
    </Button>
    <p class="text-small text-w4s-steel">
      * Réponse sous 30 min en heures ouvrées
    </p>
  </div>
</form>

<!-- Success/Error messages -->
<div id="form-success" class="hidden bg-w4s-success/10 text-w4s-success rounded-xl p-6 text-center">
  <Icon name="check-circle" size={32} class="mx-auto mb-2" />
  <p class="font-medium">Demande envoyée !</p>
  <p class="text-small">Nous vous recontactons sous 30 minutes.</p>
</div>

<div id="form-error" class="hidden bg-w4s-urgent/10 text-w4s-urgent rounded-xl p-6 text-center">
  <Icon name="alert-circle" size={32} class="mx-auto mb-2" />
  <p class="font-medium">Une erreur s'est produite</p>
  <p class="text-small">Veuillez réessayer ou nous appeler directement.</p>
</div>

<script>
  const form = document.getElementById('contact-form') as HTMLFormElement;
  const successMsg = document.getElementById('form-success');
  const errorMsg = document.getElementById('form-error');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    try {
      const response = await fetch(form.action, {
        method: 'POST',
        body: new FormData(form),
        headers: { 'Accept': 'application/json' }
      });
      
      if (response.ok) {
        form.style.display = 'none';
        successMsg?.classList.remove('hidden');
      } else {
        throw new Error('Form submission failed');
      }
    } catch (error) {
      errorMsg?.classList.remove('hidden');
    }
  });
</script>
